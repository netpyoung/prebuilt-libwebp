name: Release with Tag

on:
  push:
    tags:
      - '*'

jobs:

  ## ======================================================================================================
  upload_asset_windows:
    name: Upload Asset on Windows
    # ref: availabel image - https://github.com/actions/runner-images
    runs-on: windows-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v5

      # https://github.com/ilammy/msvc-dev-cmd
      - name: Install Dependency x86_64
        uses: ilammy/msvc-dev-cmd@v1
        with:
            arch: x86_64
      # https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#jobsjob_idstepsshell
      - name: Run Buildscript - x64
        shell: pwsh
        run: .\build-on-windows.ps1 x64

      - name: Install Dependency x86
        uses: ilammy/msvc-dev-cmd@v1
        with:
            arch: x86
      - name: Run Buildscript - x86
        shell: pwsh
        run: .\build-on-windows.ps1 x86

      - name: Install Dependency amd64_arm
        uses: ilammy/msvc-dev-cmd@v1
        with:
            arch: x86_arm64
      - name: Run Buildscript - x86_arm64
        shell: pwsh
        run: .\build-on-windows.ps1 ARM

#      - name: Run Zip
#        shell: pwsh
#        run: powershell -command "Compress-Archive -Path 'lib\windows\*' -DestinationPath 'windows.zip' -Force"

      # https://github.com/actions/upload-artifact
      - name: ðŸŽâ« Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-windows
          path: lib/windows/
          if-no-files-found: error
          retention-days: 1
          compression-level: 0


  ## ======================================================================================================
  upload_asset_linux:
    name: Upload Asset on Linux
    # ref: availabel image - https://github.com/actions/runner-images
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run Buildscript
        run: ./build-on-linux.sh

      # https://github.com/actions/upload-artifact
      - name: ðŸŽâ« Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-linux
          path: lib/linux_64/
          if-no-files-found: error
          retention-days: 1
          compression-level: 0


  ## ======================================================================================================
  upload_asset_android:
    name: Upload Asset on Linux (Android)
    # ref: availabel image - https://github.com/actions/runner-images
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v5

      # https://github.com/nttld/setup-ndk
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          # ref: Support 16 KB page sizes
          # - https://github.com/netpyoung/unity.webp/issues/74
          # - https://developer.android.com/guide/practices/page-sizes
          # - https://developer.android.com/ndk/downloads
          # 
          # - readelf.exe -l yourlibrary.so
          #   - Align 0x1000 => 4KB
          #   - Align 0x4000 => 16KB 
          #
          # - 2025.05.24
          #   - Latest LTS Version (r27c)
          #   - Latest Stable Version (r28b)
          ndk-version: r28b

      - name: Run Buildscript
        run: ./build-on-linux-android.sh

      # https://github.com/actions/upload-artifact
      - name: ðŸŽâ« Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-android
          path: lib/android/
          if-no-files-found: error
          retention-days: 1
          compression-level: 0


  ## ======================================================================================================
  upload_asset_macos:
    name: Upload Asset on macOS
    # ref: availabel image - https://github.com/actions/runner-images
    runs-on: macos-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Dependency
        run: brew install coreutils automake libtool

      - name: Run Buildscript
        run: ./build-on-mac.sh

      # https://github.com/actions/upload-artifact
      - name: ðŸŽâ« Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-macos
          path: lib/macOS/
          if-no-files-found: error
          retention-days: 1
          compression-level: 0

  ## ======================================================================================================
  upload_asset_macos_xcframework:
    name: Upload Asset on macOS (XCFramework)
    # ref: availabel image - https://github.com/actions/runner-images
    runs-on: macos-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Dependency
        run: brew install coreutils automake libtool

      - name: Run Buildscript
        run: ./build-on-mac-xcframework.zsh

      # https://github.com/actions/upload-artifact
      - name: ðŸŽâ« Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-macos-xcframework
          path: lib/macOS_xcframework/
          if-no-files-found: error
          retention-days: 1
          compression-level: 0

  ## ======================================================================================================
  upload_asset_linux_wasm:
    name: Upload Asset on Linux (wasm)
    # ref: availabel image - https://github.com/actions/runner-images
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Dependency
        run: |
          sudo apt update
          sudo apt install -y git python3 cmake build-essential

      # https://github.com/mymindstorm/setup-emsdk
      - name: Setup emsdk
        uses: mymindstorm/setup-emsdk@v14
        with:
          actions-cache-folder: 'emsdk-cache'

      - name: Run Buildscript
        run: ./build-on-linux-wasm.sh

      # https://github.com/actions/upload-artifact
      - name: ðŸŽâ« Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-wasm
          path: lib/wasm/
          if-no-files-found: error
          retention-days: 1
          compression-level: 0

  ## ======================================================================================================
  release:
    needs: [upload_asset_windows, upload_asset_linux, upload_asset_linux_wasm, upload_asset_android, upload_asset_macos, upload_asset_macos_xcframework]
    name: Write Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            CHANGELOG.md

      - name: Make Directory For Download Artifacts
        run: |
          mkdir -p download-artifacts

      # https://github.com/actions/download-artifact
      - name: ðŸŽâ¬ Download Artifact
        uses: actions/download-artifact@v5
        with:
          path: download-artifacts

      - name: ðŸ“¦ Zip Artifacts
        run: |
          cd download-artifacts
          
          zip -r android.zip           artifact-android/
          zip -r wasm.zip              artifact-wasm/
          zip -r linux.zip             artifact-linux/
          zip -r windows.zip           artifact-windows/
          zip -r macos.zip             artifact-macos/
          zip -r macos-xcframework.zip artifact-macos-xcframework/

      - name: Log artifact download
        run: |
          ls -alh
          ls -alh download-artifacts

      - name: Get Tagname
        id: tag_name
        run: |
          echo "current_version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Changelog Reader
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2
        with:
          version: ${{ steps.tag_name.outputs.current_version }}
          path: ./CHANGELOG.md

      # https://github.com/softprops/action-gh-release
      - name: ðŸš€ Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: false
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref }}
          body: ${{ steps.changelog_reader.outputs.changes }}
          fail_on_unmatched_files: true
          files: |
            ./download-artifacts/android.zip
            ./download-artifacts/wasm.zip
            ./download-artifacts/linux.zip
            ./download-artifacts/windows.zip
            ./download-artifacts/macos.zip
            ./download-artifacts/macos-xcframework.zip

